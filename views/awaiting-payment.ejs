<!-- views/awaiting-payment.ejs -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Aguardando Pagamento - Jyl Store</title>
    <style>
        body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #2c2f33; color: white; text-align: center; }
        .container { background-color: #23272a; padding: 40px; border-radius: 8px; max-width: 500px; }
        .status { margin-top: 20px; padding: 10px; border-radius: 5px; font-weight: bold; }
        .status.pending { background-color: #f0ad4e; }
        .status.approved { background-color: #5cb85c; }
        .status.declined { background-color: #d9534f; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #5865F2; border-radius: 50%; width: 30px; height: 30px; animation: spin 2s linear infinite; display: inline-block; margin-top: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .pix-key { background-color: #1e1f22; padding: 10px; border-radius: 5px; margin: 15px 0; font-family: monospace; word-wrap: break-word; }
        form { margin-top: 20px; }
        input[type="file"] { background-color: #40444b; color: white; padding: 10px; border-radius: 5px; border: none; }
        button { background-color: #5865F2; color: white; padding: 12px 20px; border-radius: 5px; border: none; font-size: 16px; cursor: pointer; margin-top: 10px; }
        button:hover { background-color: #4752c4; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Pedido: <%= order.id %></h1>
        <p>Você está comprando: <strong><%= product.name %></strong></p>
        <p>Valor: <strong>R$ <%= product.price %></strong></p>

        <% if (order.status === 'analise') { %>
            <p>Para continuar, faça o pagamento via Pix e envie o comprovante abaixo.</p>
            <p><strong>Chave Pix (Copia e Cola):</strong></p>
            <div class="pix-key"><%= pix_key %></div>
            <form action="/order/upload/<%= order.id %>" method="post" enctype="multipart/form-data">
                <input type="file" name="receipt" accept="image/*" required>
                <br>
                <button type="submit">Enviar Comprovante</button>
            </form>
        <% } else if (order.status === 'pending_approval') { %>
            <div class="status pending">
                Aguardando Aprovação
            </div>
            <p>Seu comprovante foi enviado! Nossa equipe irá analisá-lo em breve.</p>
            <div class="loader"></div>
        <% } %>
    </div>

    <!-- ================================================== -->
    <!-- |||||||||||||||||| SCRIPT ESSENCIAL |||||||||||||||| -->
    <!-- ================================================== -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Só executa o script se o pedido estiver aguardando aprovação
        if ('<%= order.status %>' === 'pending_approval') {
            const orderId = '<%= order.id %>';
            
            // 1. Conecta ao servidor Socket.IO
            const socket = io();

            // 2. Entra na sala específica deste pedido
            socket.on('connect', () => {
                console.log('Conectado ao servidor! Entrando na sala do pedido:', orderId);
                socket.emit('join_order_room', orderId);
            });

            // 3. Escuta por atualizações de status vindas do servidor
            socket.on('order_status_update', (data) => {
                console.log('Status do pedido atualizado:', data.status);
                // 4. Se o pedido for aprovado, redireciona para a página de chat
                if (data.status === 'approved') {
                    window.location.href = `/order/chat/${orderId}`;
                }
                // 5. Se o pedido for recusado, atualiza a página com a mensagem de erro
                else if (data.status === 'declined') {
                    const container = document.querySelector('.container');
                    container.innerHTML = `<div class="status declined">Comprovante Recusado</div>
                                           <p>Se você acredita que isso foi um erro, mande um ticket de suporte no servidor da Jyl Store.</p>`;
                }
            });

            socket.on('disconnect', () => {
                console.log('Desconectado do servidor.');
            });
        }
    </script>
</body>
</html>